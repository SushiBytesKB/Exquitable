<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delete Reservation</title>
    <link rel="stylesheet" href="./CSS/booking.css" />
    <style>
      .delete-container {
        max-width: 600px;
        margin: 0 auto;
      }

      .reservation-details {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .reservation-details h2 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
      }

      .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }

      .detail-row:last-child {
        border-bottom: none;
      }

      .detail-label {
        font-weight: bold;
        color: #666;
      }

      .detail-value {
        color: #333;
      }

      .warning-box {
        background-color: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .warning-box h3 {
        margin-top: 0;
        color: #856404;
      }

      .warning-box p {
        margin: 10px 0;
        color: #856404;
      }

      .button-group {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .btn-delete {
        background-color: #f44336;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        flex: 1;
      }

      .btn-delete:hover {
        background-color: #da190b;
      }

      .btn-delete:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .btn-cancel {
        background-color: #6c757d;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        flex: 1;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-cancel:hover {
        background-color: #5a6268;
      }

      .error-message {
        color: red;
        margin-top: 10px;
        padding: 10px;
        background-color: #ffe6e6;
        border-radius: 5px;
        display: none;
      }

      .success-message {
        color: green;
        margin-top: 10px;
        padding: 10px;
        background-color: #e6ffe6;
        border-radius: 5px;
        display: none;
      }

      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        color: #333;
        text-decoration: none;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="bookings_container">
      <a href="bookings.html" class="back-link">← Back to Bookings</a>
      <h1>Delete Reservation</h1>
      
      <div class="delete-container">
        <div id="loadingMessage" class="loading">Loading reservation details...</div>
        
        <div id="reservationContent" style="display: none;">
          <div class="warning-box">
            <h3>⚠️ Warning</h3>
            <p>
              You are about to permanently delete this reservation. This action
              cannot be undone.
            </p>
          </div>

          <div class="reservation-details" id="reservationDetails">
            <!-- Reservation details will be populated here -->
          </div>

          <div class="error-message" id="errorMessage"></div>
          <div class="success-message" id="successMessage"></div>

          <div class="button-group">
            <button
              type="button"
              class="btn-delete"
              id="deleteBtn"
              onclick="confirmDelete()"
            >
              Delete Reservation
            </button>
            <a href="bookings.html" class="btn-cancel">Cancel</a>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { supabase } from "./JS/supabaseClient.js";

      // Get reservation ID from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const reservationId = urlParams.get("id");

      if (!reservationId) {
        document.getElementById("loadingMessage").textContent =
          "Error: No reservation ID provided.";
      } else {
        // Only proceed if reservationId exists
        let reservationData = null;

      // Function to show error message
      function showError(message) {
        const errorMessage = document.getElementById("errorMessage");
        errorMessage.textContent = message;
        errorMessage.style.display = "block";
        document.getElementById("successMessage").style.display = "none";
      }

      // Function to show success message
      function showSuccess(message) {
        const successMessage = document.getElementById("successMessage");
        successMessage.textContent = message;
        successMessage.style.display = "block";
        document.getElementById("errorMessage").style.display = "none";
      }

      // Function to format date/time
      function formatDateTime(dateString) {
        if (!dateString) return "N/A";
        const date = new Date(dateString);
        return date.toLocaleString();
      }

      // Function to render reservation details
      function renderReservationDetails(reservation, tableInfo) {
        const detailsContainer = document.getElementById("reservationDetails");
        const tableName = tableInfo ? tableInfo.table_name : "N/A";
        const roomName = tableInfo ? tableInfo.room_name : "N/A";
        
        detailsContainer.innerHTML = `
          <h2>Reservation Details</h2>
          <div class="detail-row">
            <span class="detail-label">Reservation ID:</span>
            <span class="detail-value">${reservation.id}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Customer Name:</span>
            <span class="detail-value">${reservation.customer_name || "N/A"}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Customer Email:</span>
            <span class="detail-value">${reservation.customer_email || "N/A"}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Room:</span>
            <span class="detail-value">${roomName}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Table:</span>
            <span class="detail-value">${tableName}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Start Time:</span>
            <span class="detail-value">${formatDateTime(reservation.start_time)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Predicted End Time:</span>
            <span class="detail-value">${formatDateTime(reservation.predicted_end_time)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Actual End Time:</span>
            <span class="detail-value">${formatDateTime(reservation.actual_end_time)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Guest Count:</span>
            <span class="detail-value">${reservation.guest_count || "N/A"}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Status:</span>
            <span class="detail-value">${reservation.status || "N/A"}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Price Paid:</span>
            <span class="detail-value">${reservation.price_paid ? `$${reservation.price_paid.toFixed(2)}` : "N/A"}</span>
          </div>
        `;
      }

      // Load reservation details
      async function loadReservationDetails() {
        try {
          // 1. Fetch reservation data
          const { data: reservation, error: reservationError } = await supabase
            .from("reservations")
            .select("*")
            .eq("id", reservationId)
            .single();

          if (reservationError) {
            console.error("Error loading reservation:", reservationError);
            document.getElementById("loadingMessage").textContent =
              `Error loading reservation: ${reservationError.message}`;
            return;
          }

          if (!reservation) {
            document.getElementById("loadingMessage").textContent =
              "Reservation not found.";
            return;
          }

          reservationData = reservation;
          console.log("Reservation data loaded:", reservation);
          console.log("Reservation table_id:", reservation.table_id);

          // 2. Fetch table information from restaurant_seating using table_id and restaurant_id
          let tableInfo = null;
          if (reservation.table_id) {
            console.log("Fetching table info for table_id:", reservation.table_id);
            console.log("Restaurant ID from reservation:", reservation.restaurant_id);
            
            // Query with both table_id and restaurant_id to ensure RLS policies allow access
            const { data: tableData, error: tableError } = await supabase
              .from("restaurant_seating")
              .select("table_name, room_name")
              .eq("id", reservation.table_id)
              .eq("restaurant_id", reservation.restaurant_id)
              .limit(1);

            console.log("Table query result - data:", tableData);
            console.log("Table query result - error:", tableError);

            if (tableError) {
              console.error("Error loading table info:", tableError);
              // Try querying without restaurant_id filter as fallback
              console.log("Trying fallback query without restaurant_id filter...");
              const { data: fallbackData, error: fallbackError } = await supabase
                .from("restaurant_seating")
                .select("table_name, room_name")
                .eq("id", reservation.table_id)
                .limit(1);
              
              if (!fallbackError && fallbackData && fallbackData.length > 0) {
                tableInfo = fallbackData[0];
                console.log("Table info found with fallback query:", tableInfo);
              }
            } else if (tableData && tableData.length > 0) {
              tableInfo = tableData[0];
              console.log("Table info found:", tableInfo);
            } else {
              console.log("Table not found for table_id:", reservation.table_id);
              console.log("Query returned empty array or null");
              // Continue without table info
            }
          } else {
            console.log("No table_id in reservation");
          }

          // 3. Render reservation details with table info
          renderReservationDetails(reservation, tableInfo);
          document.getElementById("loadingMessage").style.display = "none";
          document.getElementById("reservationContent").style.display = "block";
        } catch (err) {
          console.error("Unexpected error:", err);
          document.getElementById("loadingMessage").textContent =
            `An unexpected error occurred: ${err.message}`;
        }
      }

      // Delete function (exposed globally for onclick)
      window.confirmDelete = async function () {
        const confirmed = confirm(
          "Are you absolutely sure you want to delete this reservation? This action cannot be undone."
        );

        if (!confirmed) {
          return;
        }

        const deleteBtn = document.getElementById("deleteBtn");
        deleteBtn.disabled = true;
        deleteBtn.textContent = "Deleting...";

        try {
          const { error } = await supabase
            .from("reservations")
            .delete()
            .eq("id", reservationId);

          if (error) {
            console.error("❌ Error deleting reservation:", error);
            showError(`Failed to delete reservation: ${error.message}`);
            deleteBtn.disabled = false;
            deleteBtn.textContent = "Delete Reservation";
          } else {
            showSuccess("Reservation successfully deleted!");
            
            // Redirect to bookings page after 2 seconds
            setTimeout(() => {
              window.location.href = "bookings.html";
            }, 2000);
          }
        } catch (err) {
          console.error("❌ Unexpected error:", err);
          showError(`An unexpected error occurred: ${err.message}`);
          deleteBtn.disabled = false;
          deleteBtn.textContent = "Delete Reservation";
        }
      };

        // Load reservation details on page load
        loadReservationDetails();
      }
    </script>
  </body>
</html>

